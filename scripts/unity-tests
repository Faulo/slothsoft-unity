#!/usr/bin/env php
<?php
declare(strict_types = 1);

use Slothsoft\Unity\UnityHub;
use Slothsoft\Core\DOMHelper;
use Slothsoft\Core\FileSystem;

array_shift($_SERVER['argv']);
$_SERVER['argc'] --;

include $_composer_autoload_path ?? __DIR__ . '/../vendor/autoload.php';

if ($_SERVER['argc'] < 2) {
    echo <<<'EOT'
    Run all tests inside a Unity project.
        
    Usage:
    composer exec unity-tests "path/to/project" [EditMode|PlayMode|Platform]
            
    EOT;
    return;
}

$args = $_SERVER['argv'];

$workspace = array_shift($args);

UnityHub::setLoggingEnabled(true);

$hub = new UnityHub();

if (! $hub->isInstalled()) {
    throw new \Exception("Failed to find Unity Hub!");
}

if (! is_dir($workspace)) {
    throw new \Exception("Workspace '$workspace' is not a directory!");
}

$workspace = realpath($workspace);

$project = $hub->findProject($workspace);

if (! $project) {
    throw new \Exception("Workspace '$workspace' does not contain a Unity project!");
}

if (! $project->ensureEditorIsInstalled()) {
    throw new \Exception("Editor installation for project '$project' failed!");
}

$reportDirectory = $workspace . DIRECTORY_SEPARATOR . 'test-reports';

FileSystem::removeDir($reportDirectory, true);
if (! is_dir($reportDirectory)) {
    mkdir($reportDirectory, 0777, true);
}

$dom = new DOMHelper();

foreach ($args as $testMode) {
    $document = $project->runTests($testMode);

    $document = $dom->transformToDocument($document, 'farah://slothsoft@unity/xsl/to-junit');

    $document->formatOutput = true;
    $document->save($reportDirectory . DIRECTORY_SEPARATOR . "$testMode.xml");
}

return 0;